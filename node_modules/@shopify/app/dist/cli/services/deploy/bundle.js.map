{"version":3,"file":"bundle.js","sourceRoot":"","sources":["../../../../src/cli/services/deploy/bundle.ts"],"names":[],"mappings":"AAEA,OAAO,EAAC,GAAG,EAAC,MAAM,gCAAgC,CAAA;AAClD,OAAO,EAAC,gBAAgB,EAAC,MAAM,0BAA0B,CAAA;AAEzD,OAAO,EAAC,oBAAoB,EAAE,SAAS,EAAE,SAAS,EAAC,MAAM,0BAA0B,CAAA;AACnF,OAAO,EAAC,QAAQ,EAAC,MAAM,4BAA4B,CAAA;AACnD,OAAO,EAAC,IAAI,EAAC,MAAM,8BAA8B,CAAA;AASjD,MAAM,CAAC,KAAK,UAAU,wBAAwB,CAAC,OAAsB;IACnE,MAAM,oBAAoB,CAAC,KAAK,EAAE,MAAM,EAAE,EAAE;QAC1C,MAAM,eAAe,GAAG,QAAQ,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAA;QAClD,MAAM,SAAS,CAAC,eAAe,CAAC,CAAA;QAChC,MAAM,SAAS,CAAC,QAAQ,CAAC,eAAe,EAAE,UAAU,CAAC,CAAC,CAAA;QAEtD,MAAM,YAAY,GAAG,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAA;QAC/F,IAAI,YAAY,EAAE;YAChB,4EAA4E;YAC5E,6FAA6F;YAC7F,MAAM,IAAI,CAAC,KAAK,EAAE,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,WAAW,CAAC,EAAE,EAAC,GAAG,EAAE,OAAO,CAAC,GAAG,CAAC,SAAS,EAAC,CAAC,CAAA;SACrF;QAED,MAAM,gBAAgB,CAAC;YACrB,SAAS,EAAE,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC,SAAS,EAAE,EAAE;gBACrD,OAAO;oBACL,MAAM,EAAE,SAAS,CAAC,eAAe;oBACjC,MAAM,EAAE,KAAK,EAAE,MAAgB,EAAE,MAAgB,EAAE,MAAmB,EAAE,EAAE;wBACxE,MAAM,SAAS,CAAC,cAAc,CAC5B,EAAC,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,EAAE,OAAO,CAAC,GAAG,EAAC,EAC1C,OAAO,CAAC,WAAW,EACnB,eAAe,CAChB,CAAA;oBACH,CAAC;iBACF,CAAA;YACH,CAAC,CAAC;YACF,cAAc,EAAE,KAAK;SACtB,CAAC,CAAA;QAEF,IAAI,OAAO,CAAC,UAAU,EAAE;YACtB,MAAM,GAAG,CAAC;gBACR,cAAc,EAAE,eAAe;gBAC/B,aAAa,EAAE,OAAO,CAAC,UAAU;aAClC,CAAC,CAAA;SACH;IACH,CAAC,CAAC,CAAA;AACJ,CAAC","sourcesContent":["import {AppInterface} from '../../models/app/app.js'\nimport {Identifiers} from '../../models/app/identifiers.js'\nimport {zip} from '@shopify/cli-kit/node/archiver'\nimport {renderConcurrent} from '@shopify/cli-kit/node/ui'\nimport {AbortSignal} from '@shopify/cli-kit/node/abort'\nimport {inTemporaryDirectory, mkdirSync, touchFile} from '@shopify/cli-kit/node/fs'\nimport {joinPath} from '@shopify/cli-kit/node/path'\nimport {exec} from '@shopify/cli-kit/node/system'\nimport {Writable} from 'stream'\n\nexport interface BundleOptions {\n  app: AppInterface\n  bundlePath?: string\n  identifiers: Identifiers\n}\n\nexport async function bundleAndBuildExtensions(options: BundleOptions) {\n  await inTemporaryDirectory(async (tmpDir) => {\n    const bundleDirectory = joinPath(tmpDir, 'bundle')\n    await mkdirSync(bundleDirectory)\n    await touchFile(joinPath(bundleDirectory, '.shopify'))\n\n    const javyRequired = options.app.allExtensions.some((ext) => ext.features.includes('function'))\n    if (javyRequired) {\n      // Force the download of the javy binary in advance to avoid later problems,\n      // as it might be done multiple times in parallel. https://github.com/Shopify/cli/issues/2877\n      await exec('npm', ['exec', '--', 'javy', '--version'], {cwd: options.app.directory})\n    }\n\n    await renderConcurrent({\n      processes: options.app.allExtensions.map((extension) => {\n        return {\n          prefix: extension.localIdentifier,\n          action: async (stdout: Writable, stderr: Writable, signal: AbortSignal) => {\n            await extension.buildForBundle(\n              {stderr, stdout, signal, app: options.app},\n              options.identifiers,\n              bundleDirectory,\n            )\n          },\n        }\n      }),\n      showTimestamps: false,\n    })\n\n    if (options.bundlePath) {\n      await zip({\n        inputDirectory: bundleDirectory,\n        outputZipPath: options.bundlePath,\n      })\n    }\n  })\n}\n"]}